import streamlit as st
import pandas as pd
import joblib
import os

# --- 1. é¡µé¢åŸºæœ¬è®¾ç½® ---
st.set_page_config(page_title="ä»£è°¢å¼‚å¸¸é£é™©é¢„æµ‹ç³»ç»Ÿ", page_icon="ğŸ©º", layout="centered")
st.title("ğŸ©º ä»£è°¢å¼‚å¸¸é£é™©åœ¨çº¿é¢„æµ‹ç³»ç»Ÿ")
st.markdown("æœ¬ç³»ç»ŸåŸºäºå¤šæ¨¡å‹èåˆç®—æ³•æ„å»ºï¼Œç”¨äºè¯„ä¼°ä»£è°¢å¼‚å¸¸çš„å‘ç”Ÿé£é™©ã€‚è¯·å¡«å†™ä¸‹æ–¹æ‚£è€…ä¸´åºŠæŒ‡æ ‡ã€‚")

# --- 2. æ¨¡å‹å®šä¹‰ä¸å­—å…¸æ˜ å°„ ---
MODEL_FEATURES = {
    "æ¨¡å‹Aï¼ˆå…¨å˜é‡æ¨¡å‹ï¼‰": ['ä¸‹è‚¢è‚Œè‚‰æ¯”ç‡', 'TyG æŒ‡æ•°', 'ç³–åŒ–è¡€çº¢è›‹ç™½', 'ä½“é‡æŒ‡æ•°', 'æ€»èƒ†å›ºé†‡', 'å°¿ç´ ', 'ç»†èƒå¤–æ¶²æ€»é‡/èº«ä½“æ€»æ°´åˆ†', 'Î³-è°·æ°¨é…°è½¬ç§»é…¶', 'ç”˜æ²¹ä¸‰é…¯', 'ç™½è›‹ç™½', 'å—œé…¸æ€§ç²’ç»†èƒç™¾åˆ†æ¯”', 'æ”¶ç¼©å‹', 'å—œç¢±æ€§ç²’ç»†èƒç™¾åˆ†æ¯”', 'è¡€çº¢è›‹ç™½', 'ä¸Šè‚¢è‚Œè‚‰æ¯”ç‡', 'ä¸‹è‚¢è„‚è‚ªæ¯”ç‡'],
    "æ¨¡å‹Bï¼ˆä½“æˆåˆ†æ¨¡å‹ï¼‰": ['å¹´é¾„', 'ä½“é‡æŒ‡æ•°', 'è…°è‡€æ¯”', 'ä½“è„‚è‚ª', 'ä½“è„‚ç™¾åˆ†æ¯”', 'ä¸Šè‚¢è‚Œè‚‰æ¯”ç‡', 'èº¯å¹²è‚Œè‚‰é‡æ¯”ç‡', 'ä¸‹è‚¢è‚Œè‚‰æ¯”ç‡', 'èº¯å¹²è„‚è‚ªæ¯”ç‡', 'ä¸‹è‚¢è„‚è‚ªæ¯”ç‡', 'ç»†èƒå¤–æ¶²æ€»é‡/èº«ä½“æ€»æ°´åˆ†', 'å¸çƒŸå²', 'èº«ä½“æ€»æ°´åˆ†', 'èº«ä½“æ€»æ°´åˆ†/å»è„‚ä½“é‡'],
    "æ¨¡å‹Cï¼ˆä¸´åºŠå¸¸è§„æ¨¡å‹ï¼‰": ['ç”˜æ²¹ä¸‰é…¯', 'ç³–åŒ–è¡€çº¢è›‹ç™½', 'ä½“é‡æŒ‡æ•°', 'TyG æŒ‡æ•°', 'å°¿é…¸', 'é—¨å†¬æ°¨é…¸æ°¨åŸºè½¬ç§»é…¶', 'å¹´é¾„', 'å°¿ç´ ', 'å—œé…¸æ€§ç²’ç»†èƒç™¾åˆ†æ¯”', 'è‚Œé…', 'è¡€çº¢è›‹ç™½', 'æ€»èƒ†å›ºé†‡', 'å—œç¢±æ€§ç²’ç»†èƒç™¾åˆ†æ¯”', 'ä¸™æ°¨é…¸æ°¨åŸºè½¬ç§»é…¶', 'è„‚è›‹ç™½Î±æµ‹å®š', 'çº¢ç»†èƒè®¡æ•°', 'èˆ’å¼ å‹', 'ç™½ç»†èƒè®¡æ•°', 'æ”¶ç¼©å‹', 'Î³-è°·æ°¨é…°è½¬ç§»é…¶', 'ç™½è›‹ç™½', 'è…°è‡€æ¯”'],
    "æ¨¡å‹Dï¼ˆåŸºå‡†æ¨¡å‹ï¼‰": ['æ€§åˆ«', 'å¹´é¾„', 'è¿åŠ¨é¢‘ç‡', 'å¸çƒŸå²', 'é¥®é…’å²', 'ä½“é‡æŒ‡æ•°', 'è…°è‡€æ¯”']
}

MODEL_FILES = {
    "æ¨¡å‹Aï¼ˆå…¨å˜é‡æ¨¡å‹ï¼‰": "lasso_model.pkl",
    "æ¨¡å‹Bï¼ˆä½“æˆåˆ†æ¨¡å‹ï¼‰": "svm_model.pkl",
    "æ¨¡å‹Cï¼ˆä¸´åºŠå¸¸è§„æ¨¡å‹ï¼‰": "xgb_model.pkl",
    "æ¨¡å‹Dï¼ˆåŸºå‡†æ¨¡å‹ï¼‰": "lr_model.pkl"
}

# ğŸ¯ åˆ†ç±»å˜é‡çš„å…·ä½“å®šä¹‰
OPTIONS_MAP = {
    'æ€§åˆ«': {"1 (ç”·æ€§)": 1, "0 (å¥³æ€§)": 0},
    'å¸çƒŸå²': {"0 (æ— å¸çƒŸå²)": 0, "1 (æœ‰å¸çƒŸå²)": 1},
    'é¥®é…’å²': {"0 (æ— é¥®é…’å²)": 0, "1 (æœ‰é¥®é…’å²)": 1},
    'è¿åŠ¨é¢‘ç‡': {
        "0ï¼šæå°‘ (ï¼œ1æ¬¡/å‘¨)": 0, 
        "1ï¼šå¶å°” (1-2æ¬¡/å‘¨)": 1, 
        "2ï¼šè§„å¾‹ (3-5æ¬¡/å‘¨)": 2, 
        "3ï¼šç»å¸¸ (ï¼5æ¬¡/å‘¨)": 3
    }
}

# ğŸ¯ å¼ºåˆ¶æŒ‡å®šç±»åˆ«çš„æ˜¾ç¤ºé¡ºåº
CATEGORY_ORDER = [
    'ğŸ‘¤ åŸºæœ¬äººå£å­¦åŠç”Ÿæ´»æ–¹å¼',
    'ğŸ“ ä½“æ ¼æ£€æŸ¥æŒ‡æ ‡',
    'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡',
    'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡'
]

# ğŸ¯ æŒ‡æ ‡çš„åˆ†ç±»ã€å•ä½ä¸åˆç†çš„ä¸´åºŠé»˜è®¤å€¼
FEATURE_DICT = {
    'å¹´é¾„': {'cat': 'ğŸ‘¤ åŸºæœ¬äººå£å­¦åŠç”Ÿæ´»æ–¹å¼', 'unit': 'å²', 'def': 50.0},
    'æ€§åˆ«': {'cat': 'ğŸ‘¤ åŸºæœ¬äººå£å­¦åŠç”Ÿæ´»æ–¹å¼', 'unit': '', 'def': None},
    'è¿åŠ¨é¢‘ç‡': {'cat': 'ğŸ‘¤ åŸºæœ¬äººå£å­¦åŠç”Ÿæ´»æ–¹å¼', 'unit': '', 'def': None},
    'å¸çƒŸå²': {'cat': 'ğŸ‘¤ åŸºæœ¬äººå£å­¦åŠç”Ÿæ´»æ–¹å¼', 'unit': '', 'def': None},
    'é¥®é…’å²': {'cat': 'ğŸ‘¤ åŸºæœ¬äººå£å­¦åŠç”Ÿæ´»æ–¹å¼', 'unit': '', 'def': None},
    
    'ä½“é‡æŒ‡æ•°': {'cat': 'ğŸ“ ä½“æ ¼æ£€æŸ¥æŒ‡æ ‡', 'unit': 'kg/mÂ²', 'def': 24.0},
    'è…°è‡€æ¯”': {'cat': 'ğŸ“ ä½“æ ¼æ£€æŸ¥æŒ‡æ ‡', 'unit': '', 'def': 0.85},
    'æ”¶ç¼©å‹': {'cat': 'ğŸ“ ä½“æ ¼æ£€æŸ¥æŒ‡æ ‡', 'unit': 'mmHg', 'def': 120.0},
    'èˆ’å¼ å‹': {'cat': 'ğŸ“ ä½“æ ¼æ£€æŸ¥æŒ‡æ ‡', 'unit': 'mmHg', 'def': 80.0},
    
    'ä½“è„‚è‚ª': {'cat': 'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡', 'unit': 'kg', 'def': 15.0},
    'ä½“è„‚ç™¾åˆ†æ¯”': {'cat': 'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡', 'unit': '%', 'def': 25.0},
    'ä¸Šè‚¢è‚Œè‚‰æ¯”ç‡': {'cat': 'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡', 'unit': 'ä¸Šè‚¢è‚Œè‚‰é‡/å…¨èº«è‚Œè‚‰é‡', 'def': 0.11},
    'èº¯å¹²è‚Œè‚‰é‡æ¯”ç‡': {'cat': 'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡', 'unit': 'èº¯å¹²è‚Œè‚‰é‡/å…¨èº«è‚Œè‚‰é‡', 'def': 0.47},
    'ä¸‹è‚¢è‚Œè‚‰æ¯”ç‡': {'cat': 'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡', 'unit': 'ä¸‹è‚¢è‚Œè‚‰é‡/å…¨èº«è‚Œè‚‰é‡', 'def': 0.33},
    'èº¯å¹²è„‚è‚ªæ¯”ç‡': {'cat': 'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡', 'unit': 'èº¯å¹²è„‚è‚ªé‡/å…¨èº«ä½“è„‚è‚ªé‡', 'def': 0.44},
    'ä¸‹è‚¢è„‚è‚ªæ¯”ç‡': {'cat': 'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡', 'unit': 'ä¸‹è‚¢è„‚è‚ªé‡/å…¨èº«ä½“è„‚è‚ªé‡', 'def': 0.33},
    'ç»†èƒå¤–æ¶²æ€»é‡/èº«ä½“æ€»æ°´åˆ†': {'cat': 'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡', 'unit': '', 'def': 0.38},
    'èº«ä½“æ€»æ°´åˆ†': {'cat': 'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡', 'unit': 'kg', 'def': 37.5},
    'èº«ä½“æ€»æ°´åˆ†/å»è„‚ä½“é‡': {'cat': 'âš–ï¸ ä½“æˆåˆ†æŒ‡æ ‡', 'unit': 'æ¯”å€¼', 'def': 0.73},
    
    'ç”˜æ²¹ä¸‰é…¯': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'mmol/L', 'def': 1.5},
    'ç³–åŒ–è¡€çº¢è›‹ç™½': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': '%', 'def': 5.5},
    'TyG æŒ‡æ•°': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': '', 'def': 8.5},
    'å°¿é…¸': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'Î¼mol/L', 'def': 300.0},
    'é—¨å†¬æ°¨é…¸æ°¨åŸºè½¬ç§»é…¶': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'U/L', 'def': 20.0},
    'å°¿ç´ ': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'mmol/L', 'def': 5.0},
    'å—œé…¸æ€§ç²’ç»†èƒç™¾åˆ†æ¯”': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': '%', 'def': 2.0},
    'è‚Œé…': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'Î¼mol/L', 'def': 70.0},
    'è¡€çº¢è›‹ç™½': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'g/L', 'def': 135.0},
    'æ€»èƒ†å›ºé†‡': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'mmol/L', 'def': 4.5},
    'å—œç¢±æ€§ç²’ç»†èƒç™¾åˆ†æ¯”': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': '%', 'def': 0.5},
    'ä¸™æ°¨é…¸æ°¨åŸºè½¬ç§»é…¶': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'U/L', 'def': 20.0},
    'è„‚è›‹ç™½Î±æµ‹å®š': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'mg/L', 'def': 150.0},
    'çº¢ç»†èƒè®¡æ•°': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': '10^12/L', 'def': 4.5},
    'ç™½ç»†èƒè®¡æ•°': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': '10^9/L', 'def': 6.0},
    'Î³-è°·æ°¨é…°è½¬ç§»é…¶': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'U/L', 'def': 25.0},
    'ç™½è›‹ç™½': {'cat': 'ğŸ©¸ å®éªŒå®¤æŒ‡æ ‡', 'unit': 'g/L', 'def': 45.0},
}

# --- 3. ä¾§è¾¹æ ï¼šé€‰æ‹©æ¨¡å‹ä¸ç®€ä»‹ ---
st.sidebar.header("ğŸ“‚ æ¨¡å‹é€‰æ‹©ä¸é…ç½®")
selected_model_name = st.sidebar.selectbox("è¯·é€‰æ‹©è¦ä½¿ç”¨çš„é¢„æµ‹æ¨¡å‹ï¼š", list(MODEL_FEATURES.keys()))

st.sidebar.markdown("---")
st.sidebar.info(f"æ­£åœ¨ä½¿ç”¨ï¼š\n**{selected_model_name}**")

# ğŸ’¡ æ–°å¢ï¼šç²¾ç®€ç‰ˆçš„æ¨¡å‹ä»‹ç»
with st.sidebar.expander("â„¹ï¸ æŸ¥çœ‹å„æ¨¡å‹é€‚ç”¨åœºæ™¯è¯´æ˜", expanded=True):
    st.markdown("""
    * **æ¨¡å‹Aï¼ˆå…¨å˜é‡ï¼‰**ï¼šçº³å…¥å…¨éƒ¨å¤šç»´åº¦æŒ‡æ ‡ï¼Œç”¨äºè¯„ä¼°å…¨é‡ä¿¡æ¯æ¡ä»¶ä¸‹çš„é¢„æµ‹æ€§èƒ½ä¸Šé™ã€‚
    * **æ¨¡å‹Bï¼ˆä½“æˆåˆ†ï¼‰**ï¼šåŒ…å«åŸºç¡€æŒ‡æ ‡ä¸æ— åˆ›ä½“æˆåˆ†æ•°æ®ï¼Œæ— éœ€æŠ½è¡€åŒ–éªŒã€‚é€‚åˆåœ¨åŸºå±‚åŒ»ç–—æˆ–ä»…å…·å¤‡ä½“æˆåˆ†ä»ªçš„åœºæ™¯ä¸‹è¿›è¡Œåˆç­›ã€‚
    * **æ¨¡å‹Cï¼ˆä¸´åºŠå¸¸è§„ï¼‰**ï¼šåŒ…å«åŸºç¡€æŒ‡æ ‡ä¸å¸¸è§„æŠ½è¡€ç”ŸåŒ–æ•°æ®ï¼Œä¸ä¾èµ–ä½“æˆåˆ†ä»ªã€‚è´´è¿‘ä¼ ç»Ÿä¸´åºŠå¸¸è§„è¯Šç–—åœºæ™¯ã€‚
    * **æ¨¡å‹Dï¼ˆåŸºå‡†ï¼‰**ï¼šä»…éœ€äººå£å­¦ã€ç”Ÿæ´»æ–¹å¼åŠåŸºç¡€ä½“æ ¼æŒ‡æ ‡ï¼ˆBMI/è…°è‡€æ¯”ï¼‰ï¼Œä½œä¸ºæœ€åŸºç¡€çš„å¯¹ç…§å‚è€ƒã€‚
    """)

# --- 4. ä¸»ç•Œé¢ï¼šåŠ¨æ€ã€åˆ†ç±»ç”Ÿæˆè¾“å…¥è¡¨å• ---
features = MODEL_FEATURES[selected_model_name]
input_data = {}

unsorted_categories = list(set([FEATURE_DICT[f]['cat'] for f in features if f in FEATURE_DICT]))
categories_in_model = sorted(unsorted_categories, key=lambda x: CATEGORY_ORDER.index(x) if x in CATEGORY_ORDER else 99)

with st.form("prediction_form"):
    for category in categories_in_model:
        st.markdown(f"### {category}")
        cat_features = [f for f in features if f in FEATURE_DICT and FEATURE_DICT[f]['cat'] == category]
        
        col1, col2 = st.columns(2)
        for i, feature in enumerate(cat_features):
            col = col1 if i % 2 == 0 else col2
            unit_text = f" ({FEATURE_DICT[feature]['unit']})" if FEATURE_DICT[feature]['unit'] else ""
            display_label = f"{feature}{unit_text}"
            
            with col:
                if feature in OPTIONS_MAP:
                    option_dict = OPTIONS_MAP[feature]
                    display_choice = st.selectbox(display_label, options=list(option_dict.keys()))
                    input_data[feature] = option_dict[display_choice]
                else:
                    default_val = FEATURE_DICT[feature]['def']
                    input_data[feature] = st.number_input(display_label, value=default_val, format="%f")
        st.markdown("<br>", unsafe_allow_html=True)

    submitted = st.form_submit_button("ğŸš€ ç‚¹å‡»è¿›è¡Œé£é™©é¢„æµ‹", use_container_width=True)

# --- 5. æ‰§è¡Œé¢„æµ‹é€»è¾‘ ---
if submitted:
    processed_data = input_data.copy()
    
    # ğŸ¯ åå°è‡ªåŠ¨è½¬åŒ–
    if 'èº«ä½“æ€»æ°´åˆ†/å»è„‚ä½“é‡' in processed_data:
        processed_data['èº«ä½“æ€»æ°´åˆ†/å»è„‚ä½“é‡'] = processed_data['èº«ä½“æ€»æ°´åˆ†/å»è„‚ä½“é‡'] * 100

    df = pd.DataFrame([processed_data])
    
    # ğŸ¯ æ¨¡å‹åˆ—åéšå½¢ä¿®å¤
    RENAME_FOR_MODEL = {
        'èº¯å¹²è„‚è‚ªæ¯”ç‡': 'èº¯å¹²è„‚è‚ªç™¾åˆ†æ¯”',
        'ä¸‹è‚¢è„‚è‚ªæ¯”ç‡': 'ä¸‹è‚¢è„‚è‚ªç™¾åˆ†æ¯”'
    }
    df = df.rename(columns=RENAME_FOR_MODEL)
    
    # ğŸ¯ å¼ºåˆ¶ç‰¹å¾æ’åºå¯¹é½
    original_feature_order = MODEL_FEATURES[selected_model_name]
    aligned_feature_order = [RENAME_FOR_MODEL.get(f, f) for f in original_feature_order]
    df = df[aligned_feature_order]
    
    try:
        model_path = MODEL_FILES[selected_model_name]
        if not os.path.exists(model_path):
            st.error(f"âŒ æ‰¾ä¸åˆ°æ¨¡å‹æ–‡ä»¶: {model_path}")
        else:
            model = joblib.load(model_path)
            pred_class = model.predict(df)[0]
            
            # ğŸ’¡ å…³é”®ä¿®å¤ï¼šç”¨ float() å¼ºåˆ¶è½¬æ¢æ ¼å¼ï¼Œé¿å…è¿›åº¦æ¡æµ®ç‚¹æ•°æŠ¥é”™
            pred_proba = float(model.predict_proba(df)[0][1])
            
            st.markdown("---")
            st.subheader("ğŸ“Š é£é™©é¢„æµ‹è¯„ä¼°ç»“æœ")
            
            if pred_proba < 0.3:
                st.success(f"**âœ… ä½é£é™©**ï¼šè¯¥æ‚£è€…ç›®å‰çš„ä»£è°¢æŒ‡æ ‡å¤„äºç›¸å¯¹å®‰å…¨èŒƒå›´ã€‚")
                st.progress(pred_proba, text=f"é£é™©æ¦‚ç‡ï¼š{pred_proba:.2%}")
            elif pred_proba < 0.6:
                st.warning(f"**âš ï¸ ä¸­ç­‰é£é™©**ï¼šè¯¥æ‚£è€…å…·æœ‰ä¸€å®šçš„ä»£è°¢å¼‚å¸¸é£é™©ï¼Œå»ºè®®ç”Ÿæ´»æ–¹å¼å¹²é¢„ã€‚")
                st.progress(pred_proba, text=f"é£é™©æ¦‚ç‡ï¼š{pred_proba:.2%}")
            else:
                st.error(f"**ğŸš¨ é«˜é£é™©**ï¼šè¯¥æ‚£è€…å‘ç”Ÿä»£è°¢å¼‚å¸¸çš„å¯èƒ½æ€§å¾ˆå¤§ï¼Œå»ºè®®ä¸´åºŠå¯†åˆ‡å…³æ³¨ã€‚")
                st.progress(pred_proba, text=f"é£é™©æ¦‚ç‡ï¼š{pred_proba:.2%}")

    except Exception as e:
        st.error(f"âŒ æ¨¡å‹è¿è¡Œå‡ºé”™ï¼š{str(e)}")
